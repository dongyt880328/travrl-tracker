<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>员工出差轨迹统计</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
    }
    #sidebar {
      width: 200px;
      background-color: #f0f0f0;
      padding: 10px;
      overflow-y: auto;
      border-right: 1px solid #ccc;
    }
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #map {
      flex: 2;
      height: 70%;
    }
    #record-panel {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background-color: #fafafa;
      border-top: 1px solid #ccc;
    }
    .employee {
      cursor: pointer;
      padding: 5px;
      border-bottom: 1px solid #ccc;
    }
    .employee:hover {
      background-color: #ddd;
    }
    label {
      display: inline-block;
      margin: 5px 0 2px;
    }
    input, select, button {
      margin-bottom: 10px;
      width: 100%;
    }
  </style>
  <script src="https://webapi.amap.com/maps?v=2.0&key=8f0e0846cf92cd5aa5b88febf87d0834&plugin=AMap.Geocoder"></script>
</head>
<body>
  <div id="sidebar">
    <h3>员工列表</h3>
    <div id="employee-list"></div>
    <hr />
    <h4>添加员工</h4>
    <input type="text" id="newName" placeholder="姓名" />
    <button onclick="addEmployee()">添加</button>
  </div>
  <div id="main">
    <div id="map"></div>
    <div id="record-panel">
      <h3 id="selected-employee-title">出差记录</h3>
      <div id="records"></div>
      <h4>添加出差记录</h4>
      <label>开始日期</label>
      <input type="date" id="startDate" />
      <label>结束日期（可选）</label>
      <input type="date" id="endDate" />
      <label>状态</label>
      <select id="status">
        <option>出差中</option>
        <option>驻地</option>
        <option>请假</option>
      </select>
      <label>地点</label>
      <input type="text" id="location" placeholder="点击地图选择地点" readonly />
      <button onclick="addRecord()">添加记录</button>
    </div>
  </div>

  <script>
    let map, geocoder, currentMarker;
    const employees = [];
    const records = {};

    function initMap() {
      map = new AMap.Map("map", {
        zoom: 5,
        center: [116.397428, 39.90923]
      });
      geocoder = new AMap.Geocoder();
      map.on("click", function(e) {
        geocoder.getAddress([e.lnglat.lng, e.lnglat.lat], function(status, result) {
          if (status === "complete" && result.regeocode) {
            document.getElementById("location").value = result.regeocode.formattedAddress;
          }
        });
      });
    }

    function addEmployee() {
      const name = document.getElementById("newName").value.trim();
      if (!name || employees.includes(name)) return;
      employees.push(name);
      records[name] = [];
      updateEmployeeList();
      document.getElementById("newName").value = "";
    }

    function updateEmployeeList() {
      const list = document.getElementById("employee-list");
      list.innerHTML = "";
      employees.forEach(name => {
        const div = document.createElement("div");
        div.className = "employee";
        div.textContent = name;
        div.onclick = () => selectEmployee(name);
        list.appendChild(div);
      });
    }

    let selectedEmployee = null;
    function selectEmployee(name) {
      selectedEmployee = name;
      document.getElementById("selected-employee-title").textContent = `【${name}】的出差记录`;
      updateRecords();
      if (currentMarker) map.remove(currentMarker);
      const current = records[name].find(r => !r.end);
      if (current) {
        geocoder.getLocation(current.location, (status, result) => {
          if (status === "complete" && result.geocodes.length) {
            const pos = result.geocodes[0].location;
            currentMarker = new AMap.Marker({
              map: map,
              position: pos,
              icon: new AMap.Icon({
                image: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png",
                size: new AMap.Size(40, 40)
              })
            });
            map.setCenter(pos);
            map.setZoom(10);
          }
        });
      }
    }

    function updateRecords() {
      const box = document.getElementById("records");
      box.innerHTML = "";
      if (!selectedEmployee) return;
      const recs = records[selectedEmployee] || [];
      recs.forEach((r, i) => {
        const div = document.createElement("div");
        div.textContent = `${r.start} ~ ${r.end || "现在"} - ${r.location}（${r.status}）`;
        box.appendChild(div);
      });
    }

    function addRecord() {
      if (!selectedEmployee) return alert("请先选择员工");
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      const status = document.getElementById("status").value;
      const location = document.getElementById("location").value;
      if (!start || !location) return alert("请填写完整");
      records[selectedEmployee].push({ start, end, status, location });
      updateRecords();
    }

    window.onload = initMap;
  </script>
</body>
</html>
