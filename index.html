<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å‘˜å·¥å‡ºå·®è½¨è¿¹ç»Ÿè®¡</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; display: flex; height: 100vh; }
    #sidebar { width: 240px; border-right: 1px solid #ccc; padding: 10px; box-sizing: border-box; }
    #map { flex: 1; position: relative; }
    #mapContainer { width:100%;height:70%; }
    #recordList { height:30%; overflow-y:auto; border-top:1px solid #ccc; padding:5px; }
    button, input, select { margin:5px; padding:5px; }
    li { margin:5px 0; }
    .active { font-weight: bold; color: blue; }
  </style>
</head>
<body>

<div id="sidebar">
  <h3>ğŸ‘¥ äººå‘˜ç®¡ç†</h3>
  <input type="text" id="newEmp" placeholder="æ–°å‘˜å·¥å§“å"/><button onclick="addEmployee()">æ·»åŠ </button>
  <ul id="empList"></ul>
  <hr>
  <button onclick="showForm()">æ·»åŠ å‡ºå·®è®°å½•</button>
  <button onclick="exportCSV()">å¯¼å‡ºCSV</button>
  <div id="form" style="display:none;">
    <h4>å‡ºå·®è®°å½•</h4>
    å§“åï¼š<span id="formEmp"></span><br>
    çŠ¶æ€ï¼š<select id="statusSelect"><option>å‡ºå·®ä¸­</option><option>é©»åœ°</option><option>è¯·å‡</option></select><input id="newSt" placeholder="æ–°å¢çŠ¶æ€å›è½¦"/><br>
    èµ·å§‹ï¼š<input type="datetime-local" id="start"/><br>
    ç»“æŸï¼š<input type="datetime-local" id="end"/><br>
    ç»åº¦ï¼š<input id="lng" readonly> çº¬åº¦ï¼š<input id="lat" readonly><br>
    <small>ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®</small><br>
    <button onclick="saveRecord()">ä¿å­˜</button><button onclick="hideForm()">å–æ¶ˆ</button>
  </div>
</div>

<div id="map">
  <div id="mapContainer"></div>
  <div id="recordList"></div>
</div>

<script src="https://webapi.amap.com/maps?v=2.0&key=ce4f1cf51cbf10635e015fd1ff71f40a"></script>
<script>
  let employees = JSON.parse(localStorage.getItem('employees')||'[]');
  let records = JSON.parse(localStorage.getItem('records')||'[]');
  let selected = null;
  let map = new AMap.Map('mapContainer',{zoom:5,center:[116.397428,39.90923]});
  let marker = null;
  let footsteps = [];

  function saveData() {
    localStorage.setItem('employees',JSON.stringify(employees));
    localStorage.setItem('records',JSON.stringify(records));
  }

  function renderEmpList() {
    const ul = document.getElementById('empList');
    ul.innerHTML = '';
    employees.forEach((e,i)=>{
      const li = document.createElement('li');
      li.innerHTML = `<span onclick="selectEmp(${i})" class="${selected===i?'active':''}">${e}</span> 
        <button onclick="delEmp(${i})">åˆ </button>`;
      ul.appendChild(li);
    });
  }

  function addEmployee(){
    const nm = document.getElementById('newEmp').value.trim();
    if(nm && !employees.includes(nm)){ employees.push(nm); saveData(); renderEmpList(); }
    document.getElementById('newEmp').value='';
  }

  function delEmp(i){
    if(confirm('åˆ é™¤å‘˜å·¥åŠå…¶è®°å½•ï¼Ÿ')) {
      employees.splice(i,1);
      records = records.filter(r=>r.emp!==employees[i]);
      if(selected===i) selected=null;
      saveData(); renderEmpList(); renderMap(); renderList();
    }
  }

  function selectEmp(i){
    selected=i;
    renderEmpList();
    renderMap();
    renderList();
  }

  function showForm(){
    if(selected===null) return alert('è¯·å…ˆé€‰æ‹©å‘˜å·¥');
    document.getElementById('form').style.display='block';
    document.getElementById('formEmp').innerText=employees[selected];
    document.getElementById('lng').value='';
    document.getElementById('lat').value='';
  }

  function hideForm(){
    document.getElementById('form').style.display='none';
  }

  document.getElementById('newSt').addEventListener('keydown',e=>{
    if(e.key==='Enter'){
      const val=e.target.value.trim();
      if(val){
        const sel=document.getElementById('statusSelect');
        sel.add(new Option(val,val));
        sel.value=val;
        e.target.value='';
      }
    }
  });

  map.on('click',e=>{
    if(!document.getElementById('form').style.display==='block')return;
    const lng=e.lnglat.getLng().toFixed(6), lat=e.lnglat.getLat().toFixed(6);
    document.getElementById('lng').value=lng;
    document.getElementById('lat').value=lat;
  });

  function saveRecord(){
    const emp=employees[selected], status=document.getElementById('statusSelect').value;
    const st=document.getElementById('start').value, en=document.getElementById('end').value;
    const lng=document.getElementById('lng').value, lat=document.getElementById('lat').value;
    if(!st||!en||!lng||!lat) return alert('è¯·å¡«å†™å®Œæ•´');
    records.push({emp,status,st,en,lng,lat});
    saveData(); hideForm(); renderMap(); renderList();
  }

  function renderMap(){
    map.clearMap(); footsteps=[]; if(selected===null)return;
    const user=employees[selected];
    const userRec = records.filter(r=>r.emp===user);
    if(userRec.length){
      const last=userRec[userRec.length-1];
      marker=new AMap.Marker({
        position:[last.lng,last.lat],
        icon: new AMap.Icon({
          image: 'https://cdn-icons-png.flaticon.com/512/149/149071.png',
          size:new AMap.Size(32,32),
        })
      });
      map.setCenter([last.lng,last.lat]);
      map.add(marker);
      const recent=userRec.slice(-5).map(r=>`${r.st}â†’${r.en} @${r.lng},${r.lat}`).join('<br>');
      document.getElementById('recordList').innerHTML=recent;
    } else {
      document.getElementById('recordList').innerText='æ— å‡ºå·®è®°å½•';
    }
  }

  function renderList(){
    // handled via renderMap
  }

  function exportCSV(){
    if(records.length===0)return alert('æ— è®°å½•');
    const header=['å§“å','çŠ¶æ€','èµ·å§‹','ç»“æŸ','ç»åº¦','çº¬åº¦'];
    const csv=[header.join(',')];
    records.forEach(r=>csv.push([r.emp,r.status,r.st,r.en,r.lng,r.lat].join(',')));
    const blob=new Blob([csv.join('\n')],{type:'text/csv'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='è®°å½•.csv';
    a.click();
  }

  renderEmpList();
  renderMap();

</script>
</body>
</html>
