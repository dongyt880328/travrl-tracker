<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å‘˜å·¥å‡ºå·®è½¨è¿¹ç»Ÿè®¡ç³»ç»Ÿ</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
      display: flex;
      height: 100vh;
      background-color: #f5f7fa;
      color: #333;
    }
    #sidebar {
      width: 280px;
      background: linear-gradient(135deg, #2c3e50, #4a6491);
      color: white;
      padding: 15px;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #map {
      height: 65%;
      border-bottom: 1px solid #ddd;
    }
    #record-panel {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background-color: white;
    }
    .employee {
      cursor: pointer;
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      background-color: rgba(255,255,255,0.1);
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .employee:hover {
      background-color: rgba(255,255,255,0.2);
    }
    .employee.active {
      background-color: #3498db;
      font-weight: bold;
    }
    label {
      display: block;
      margin: 12px 0 5px;
      font-weight: bold;
      color: #ecf0f1;
    }
    input, select, button {
      margin-bottom: 12px;
      width: 100%;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #34495e;
      background-color: rgba(255,255,255,0.9);
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }
    button:hover {
      background: #2980b9;
    }
    button.secondary {
      background: #95a5a6;
    }
    button.secondary:hover {
      background: #7f8c8d;
    }
    h3 {
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(255,255,255,0.2);
    }
    .section-title {
      margin: 20px 0 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    #records {
      margin-top: 15px;
    }
    .record-item {
      padding: 12px;
      background-color: #f8f9fa;
      border-left: 4px solid #3498db;
      margin-bottom: 10px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .record-details {
      flex: 1;
    }
    .record-actions button {
      width: auto;
      margin-left: 8px;
      padding: 6px 12px;
    }
    .record-item.current {
      border-left-color: #e74c3c;
      background-color: #fff5f5;
    }
    .record-item.leave {
      border-left-color: #2ecc71;
      background-color: #f5fffa;
    }
    #selected-employee-title {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    #export-import {
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.2);
    }
    .tools {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .tools button {
      flex: 1;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }
    .action-buttons button {
      margin-bottom: 0;
    }
    .map-controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .map-controls button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      padding: 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .employee-count {
      background: #e74c3c;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-left: 5px;
    }
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-business {
      background-color: #e74c3c;
    }
    .status-base {
      background-color: #3498db;
    }
    .status-leave {
      background-color: #2ecc71;
    }
  </style><script src="https://webapi.amap.com/maps?v=2.0&key=8f0e0846cf92cd5aa5b88febf87d0834"></script>
</head>
<body>
  <div id="sidebar">
    <h3>
      <i class="icon">ğŸ‘¥</i> å‘˜å·¥ç®¡ç†
      <span class="employee-count" id="employee-count">0</span>
    </h3>
    <div id="employee-list"></div>

    <div class="section-title">æ·»åŠ æ–°å‘˜å·¥</div>
    <input type="text" id="newName" placeholder="è¾“å…¥å‘˜å·¥å§“å" />
    <button onclick="addEmployee()">æ·»åŠ å‘˜å·¥</button>

    <div class="section-title">æ·»åŠ å‡ºå·®è®°å½•</div>
    <label>å¼€å§‹æ—¥æœŸ</label>
    <input type="date" id="startDate" />
    <label>ç»“æŸæ—¥æœŸï¼ˆå¯é€‰ï¼‰</label>
    <input type="date" id="endDate" />
    <label>çŠ¶æ€</label>
    <input type="text" id="status" placeholder="å¦‚ï¼šå‡ºå·®ä¸­ã€é©»åœ°ã€è¯·å‡ç­‰" />
    <label>åœ°ç‚¹</label>
    <input type="text" id="location" placeholder="ç‚¹å‡»åœ°å›¾é€‰æ‹©åœ°ç‚¹" readonly />
    <div class="action-buttons">
      <button onclick="addRecord()">æ·»åŠ è®°å½•</button>
      <button onclick="clearForm()" class="secondary">æ¸…ç©º</button>
    </div>

    <div id="export-import">
      <div class="section-title">æ•°æ®ç®¡ç†</div>
      <div class="tools">
        <button onclick="exportCSV()">å¯¼å‡ºCSV</button>
        <button onclick="document.getElementById('jsonFile').click()">å¯¼å…¥JSON</button>
      </div>
      <input type="file" id="jsonFile" accept=".json" style="display:none" onchange="importJSON(event)" />
    </div>
  </div>

  <div id="main">
    <div id="map"></div>
    <div id="record-panel">
      <div id="selected-employee-title">
        <h3>å‡ºå·®è®°å½•</h3>
        <button onclick="toggleHistoryTrack()" id="track-toggle">æ˜¾ç¤ºå†å²è½¨è¿¹</button>
      </div>
      <div id="records"></div>
    </div>
  </div>

  <div class="map-controls">
    <button onclick="map.zoomIn()">+</button>
    <button onclick="map.zoomOut()">-</button>
    <button onclick="resetMapView()">â†º</button>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let map, geocoder;
    const employees = [];
    const records = {};
    let selectedEmployee = null;
    let currentMarker = null;
    let historyPolyline = null;
    let showHistoryTrack = false;
    const markers = [];

    // åˆå§‹åŒ–åœ°å›¾
    function initMap() {
      map = new AMap.Map("map", {
        zoom: 5,
        center: [104.06, 35.86],
        viewMode: "3D"
      });
      
      geocoder = new AMap.Geocoder();
      
      // æ·»åŠ åœ°å›¾ç‚¹å‡»äº‹ä»¶
      map.on("click", function(e) {
        geocoder.getAddress([e.lnglat.lng, e.lnglat.lat], function(status, result) {
          if (status === "complete" && result.regeocode) {
            document.getElementById("location").value = result.regeocode.formattedAddress;
          }
        });
      });
      
      // æ·»åŠ ç¼©æ”¾æ§ä»¶
      map.addControl(new AMap.Zoom());
      
      // æ·»åŠ ä¸€äº›ç¤ºä¾‹æ•°æ®
      addExampleData();
      
      // æ ‡è®°æ‰€æœ‰å‡ºå·®ä¸­çš„å‘˜å·¥
      markCurrentBusinessEmployees();
    }

    // æ·»åŠ ç¤ºä¾‹æ•°æ®
    function addExampleData() {
      const names = ['å¼ ä¸‰', 'æå››', 'ç‹äº”', 'èµµå…­'];
      const locations = ['åŒ—äº¬å¸‚æœé˜³åŒº', 'ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº', 'å¹¿å·å¸‚å¤©æ²³åŒº', 'æ·±åœ³å¸‚å—å±±åŒº'];
      const statuses = ['å‡ºå·®ä¸­', 'é©»åœ°', 'è¯·å‡', 'å‡ºå·®ä¸­'];
      
      names.forEach((name, index) => {
        if (!employees.includes(name)) {
          employees.push(name);
          records[name] = [];
          
          const today = new Date();
          const startDate = new Date(today);
          startDate.setDate(today.getDate() - Math.floor(Math.random() * 10));
          
          records[name].push({
            start: formatDate(startDate),
            end: statuses[index] === 'å‡ºå·®ä¸­' ? '' : formatDate(new Date(startDate.getTime() + 86400000 * (Math.floor(Math.random() * 5) + 1)),
            status: statuses[index],
            location: locations[index]
          });
        }
      });
      
      updateEmployeeList();
    }

    // æ—¥æœŸæ ¼å¼åŒ–
    function formatDate(date) {
      if (!date) return '';
      const d = new Date(date);
      let month = '' + (d.getMonth() + 1);
      let day = '' + d.getDate();
      const year = d.getFullYear();
      
      if (month.length < 2) month = '0' + month;
      if (day.length < 2) day = '0' + day;
      
      return [year, month, day].join('-');
    }

    // æ·»åŠ å‘˜å·¥
    function addEmployee() {
      const name = document.getElementById("newName").value.trim();
      if (!name) {
        alert("è¯·è¾“å…¥å‘˜å·¥å§“å");
        return;
      }
      
      if (employees.includes(name)) {
        alert("è¯¥å‘˜å·¥å·²å­˜åœ¨");
        return;
      }
      
      employees.push(name);
      records[name] = [];
      updateEmployeeList();
      document.getElementById("newName").value = "";
    }

    // æ›´æ–°å‘˜å·¥åˆ—è¡¨
    function updateEmployeeList() {
      const list = document.getElementById("employee-list");
      list.innerHTML = "";
      document.getElementById("employee-count").textContent = employees.length;
      
      employees.forEach(name => {
        const div = document.createElement("div");
        div.className = "employee";
        if (name === selectedEmployee) {
          div.classList.add("active");
        }
        
        // è·å–å½“å‰çŠ¶æ€
        const currentRecord = records[name].find(r => !r.end) || {};
        let statusClass = '';
        let statusText = currentRecord.status || 'é©»åœ°';
        
        if (statusText.includes('å‡ºå·®')) statusClass = 'status-business';
        else if (statusText.includes('è¯·å‡')) statusClass = 'status-leave';
        else statusClass = 'status-base';
        
        div.innerHTML = `
          <div>
            <span class="status-indicator ${statusClass}"></span>
            ${name}
          </div>
          <span>${records[name].length}æ¡</span>
        `;
        
        div.onclick = () => selectEmployee(name);
        list.appendChild(div);
      });
    }

    // é€‰æ‹©å‘˜å·¥
    function selectEmployee(name) {
      selectedEmployee = name;
      document.getElementById("selected-employee-title").querySelector("h3").textContent = `ã€${name}ã€‘çš„å‡ºå·®è®°å½•`;
      updateRecords();
      updateEmployeeList();
      
      // æ¸…é™¤ä¹‹å‰çš„æ ‡è®°
      if (currentMarker) {
        map.remove(currentMarker);
        currentMarker = null;
      }
      
      // æ¸…é™¤å†å²è½¨è¿¹
      if (historyPolyline) {
        map.remove(historyPolyline);
        historyPolyline = null;
      }
      
      // æ˜¾ç¤ºå½“å‰å‡ºå·®ä½ç½®
      const current = records[name].find(r => !r.end);
      if (current && current.location) {
        geocoder.getLocation(current.location, (status, result) => {
          if (status === "complete" && result.geocodes.length) {
            const pos = result.geocodes[0].location;
            currentMarker = new AMap.Marker({
              map: map,
              position: pos,
              title: `${name} - ${current.status}`,
              content: `<div style="background:#e74c3c;color:white;padding:2px 6px;border-radius:12px;">${name}</div>`,
              offset: new AMap.Pixel(-15, -15)
            });
            map.setCenter(pos);
            map.setZoom(10);
          }
        });
      }
      
      // æ˜¾ç¤ºå†å²è½¨è¿¹
      if (showHistoryTrack) {
        showEmployeeHistoryTrack(name);
      }
    }

    // æ›´æ–°è®°å½•æ˜¾ç¤º
    function updateRecords() {
      const box = document.getElementById("records");
      box.innerHTML = "";
      
      if (!selectedEmployee) {
        box.innerHTML = "<p>è¯·é€‰æ‹©å‘˜å·¥æŸ¥çœ‹è®°å½•</p>";
        return;
      }
      
      const recs = records[selectedEmployee] || [];
      if (recs.length === 0) {
        box.innerHTML = "<p>æš‚æ— å‡ºå·®è®°å½•</p>";
        return;
      }
      
      // æŒ‰å¼€å§‹æ—¥æœŸæ’åº
      recs.sort((a, b) => new Date(b.start) - new Date(a.start));
      
      recs.forEach((r, i) => {
        const div = document.createElement("div");
        div.className = "record-item";
        
        if (!r.end) {
          div.classList.add("current");
        } else if (r.status.includes('è¯·å‡')) {
          div.classList.add("leave");
        }
        
        div.innerHTML = `
          <div class="record-details">
            <div><strong>${r.start} ~ ${r.end || "ç°åœ¨"}</strong></div>
            <div>${r.location}</div>
            <div>çŠ¶æ€: ${r.status}</div>
          </div>
          <div class="record-actions">
            <button onclick="editRecord(${i})">ç¼–è¾‘</button>
            <button onclick="deleteRecord(${i})" class="secondary">åˆ é™¤</button>
          </div>
        `;
        box.appendChild(div);
      });
    }

    // æ·»åŠ è®°å½•
    function addRecord() {
      if (!selectedEmployee) {
        alert("è¯·å…ˆé€‰æ‹©å‘˜å·¥");
        return;
      }
      
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      const status = document.getElementById("status").value.trim();
      const location = document.getElementById("location").value.trim();
      
      if (!start || !status || !location) {
        alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
        return;
      }
      
      // ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ
      if (end && new Date(end) < new Date(start)) {
        alert("ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ");
        return;
      }
      
      records[selectedEmployee].push({ start, end, status, location });
      updateRecords();
      selectEmployee(selectedEmployee); // åˆ·æ–°åœ°å›¾æ ‡è®°
      clearForm();
    }

    // ç¼–è¾‘è®°å½•
    function editRecord(index) {
      if (!selectedEmployee || index < 0 || index >= records[selectedEmployee].length) return;
      
      const record = records[selectedEmployee][index];
      document.getElementById("startDate").value = record.start;
      document.getElementById("endDate").value = record.end || '';
      document.getElementById("status").value = record.status;
      document.getElementById("location").value = record.location;
      
      // åˆ é™¤åŸè®°å½•
      deleteRecord(index);
    }

    // åˆ é™¤è®°å½•
    function deleteRecord(index) {
      if (!selectedEmployee || index < 0 || index >= records[selectedEmployee].length) return;
      
      if (confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) {
        records[selectedEmployee].splice(index, 1);
        updateRecords();
        selectEmployee(selectedEmployee); // åˆ·æ–°åœ°å›¾æ ‡è®°
      }
    }

    // æ¸…ç©ºè¡¨å•
    function clearForm() {
      document.getElementById("startDate").value = "";
      document.getElementById("endDate").value = "";
      document.getElementById("status").value = "";
      document.getElementById("location").value = "";
    }

    // æ ‡è®°æ‰€æœ‰å‡ºå·®ä¸­å‘˜å·¥
    function markCurrentBusinessEmployees() {
      // æ¸…é™¤ä¹‹å‰çš„æ ‡è®°
      markers.forEach(marker => map.remove(marker));
      markers.length = 0;
      
      employees.forEach(name => {
        const current = records[name].find(r => !r.end && r.status.includes('å‡ºå·®'));
        if (current && current.location) {
          geocoder.getLocation(current.location, (status, result) => {
            if (status === "complete" && result.geocodes.length) {
              const pos = result.geocodes[0].location;
              const marker = new AMap.Marker({
                map: map,
                position: pos,
                title: `${name} - ${current.status}`,
                content: `<div style="background:#e74c3c;color:white;padding:2px 6px;border-radius:12px;">${name}</div>`,
                offset: new AMap.Pixel(-15, -15)
              });
              markers.push(marker);
            }
          });
        }
      });
    }

    // å¯¼å‡ºCSV
    function exportCSV() {
      if (employees.length === 0) {
        alert("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º");
        return;
      }
      
      let csvContent = "å‘˜å·¥å§“å,å¼€å§‹æ—¥æœŸ,ç»“æŸæ—¥æœŸ,çŠ¶æ€,åœ°ç‚¹\n";
      
      employees.forEach(name => {
        records[name].forEach(record => {
          csvContent += `${name},${record.start},${record.end || ""},${record.status},${record.location}\n`;
        });
      });
      
      const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "å‘˜å·¥å‡ºå·®è®°å½•.csv");
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // å¯¼å…¥JSON
    function importJSON(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          // æ¸…é™¤ç°æœ‰æ•°æ®
          employees.length = 0;
          for (let key in records) {
            delete records[key];
          }
          
          // å¯¼å…¥æ–°æ•°æ®
          data.employees.forEach(name => employees.push(name));
          Object.assign(records, data.records);
          
          updateEmployeeList();
          markCurrentBusinessEmployees();
          alert(`æˆåŠŸå¯¼å…¥æ•°æ®ï¼Œå…±${employees.length}åå‘˜å·¥`);
        } catch (error) {
          alert("å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®");
          console.error(error);
        }
      };
      reader.readAsText(file);
    }

    // åˆ‡æ¢å†å²è½¨è¿¹æ˜¾ç¤º
    function toggleHistoryTrack() {
      showHistoryTrack = !showHistoryTrack;
      document.getElementById("track-toggle").textContent = 
        showHistoryTrack ? "éšè—å†å²è½¨è¿¹" : "æ˜¾ç¤ºå†å²è½¨è¿¹";
      
      if (showHistoryTrack && selectedEmployee) {
        showEmployeeHistoryTrack(selectedEmployee);
      } else if (historyPolyline) {
        map.remove(historyPolyline);
        historyPolyline = null;
      }
    }

    // æ˜¾ç¤ºå‘˜å·¥å†å²è½¨è¿¹
    function showEmployeeHistoryTrack(employee) {
      if (historyPolyline) {
        map.remove(historyPolyline);
        historyPolyline = null;
      }
      
      const recs = records[employee] || [];
      if (recs.length === 0) return;
      
      // è·å–æ‰€æœ‰åœ°ç‚¹åæ ‡
      const locations = recs.map(r => r.location);
      const promises = locations.map(location => {
        return new Promise(resolve => {
          geocoder.getLocation(location, (status, result) => {
            if (status === "complete" && result.geocodes.length) {
              resolve(result.geocodes[0].location);
            } else {
              resolve(null);
            }
          });
        });
      });
      
      Promise.all(promises).then(coords => {
        const validCoords = coords.filter(coord => coord !== null);
        if (validCoords.length < 2) return;
        
        historyPolyline = new AMap.Polyline({
          map: map,
          path: validCoords,
          strokeColor: "#3498db",
          strokeWeight: 4,
          strokeStyle: "solid"
        });
        
        // è°ƒæ•´è§†å›¾ä»¥æ˜¾ç¤ºæ•´ä¸ªè½¨è¿¹
        map.setFitView([historyPolyline]);
      });
    }

    // é‡ç½®åœ°å›¾è§†å›¾
    function resetMapView() {
      map.setZoomAndCenter(5, [104.06, 35.86]);
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = initMap;
  </script>
</body>
</html>
